<!DOCTYPE html>
<html>
<head>
    <title>{{ title }}</title>
    <meta http-equiv="content-type" content="text/html" charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

    <link rel="stylesheet" href="/jslib/dijit/themes/claro/claro.css">
    <link rel="stylesheet" href="/jslib/dojo/resources/dojo.css">
    <link rel="stylesheet" href="/jslib/dgrid/css/dgrid.css">
    <link rel="stylesheet" href="/jslib/dgrid/css/skins/claro.css">
    <link rel="stylesheet" href="/css/app.css">
    <script src="/js/origin_patch.js"></script>
    <script>
        var dojoConfig = {
            parseOnLoad: true, async: true,
            packages: [
                {"name": "shimmy", "location": location.pathname.match(/^\//) + "jslib/shimmy"},
                {"name": "roundgis", "location": location.pathname.match(/^\//) + "js"},
                {"name": "dgrid", "location": location.pathname.match(/^\//) + "jslib/dgrid"},
                {"name": "dstore", "location": location.pathname.match(/^\//) + "jslib/dstore"},
                {"name": "rgw", "location": location.pathname.match(/^\//) + "{{ app_js_dir }}"}
            ]
        };
    </script>
    <script>
        //global env here
        var BasicEnv = {
            lang: "{{ user_lang }}",
            curr_location: location.pathname.match(/^\//),
            templatePath: location.pathname.match(/^\//) + "templates",
            rgw_template_path: location.pathname.match(/^\//) + "{{ app_template_dir }}",
            imgpath: location.pathname.match(/^\//) + "imgs",
            standby: undefined,
            main_grid: undefined,
            watched_groupid: -1,
            poll_timer: undefined
        };
        BasicEnv.sessionid = "{{ sessionid }}";
        BasicEnv.sensor_mins_avg_trend_url = "{{ sensor_mins_avg_trend_url }}";
        BasicEnv.sensor_mins_avg_data_url = "{{ sensor_mins_avg_data_url }}";
        BasicEnv.sensor_recent_hours_plotting_url = "{{ sensor_recent_hours_plotting_url }}";
        BasicEnv.em_url = "{{ em_url }}";
    </script>

    <script src="/jslib/dojo/dojo.js"></script>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        html, body, #main_ui_node {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        .field-watched {
            width: 2em;
        }

        .field-tag {
            text-align: center;
        }

        .field-sensor_grid_watched {
            width: 2em;
        }

        .field-sensor_name {
            text-align: center;
        }

        .field-sensor_val {
            text-align: center;
        }

        .field-sensor_uts {
            text-align: center;
        }
    </style>
</head>
<body class="claro" id="body_node">
<div data-dojo-type="dijit/layout/BorderContainer"
     data-dojo-props="gutters: true, showTitle:false, iconClass: 'dijit_tab_icon_map'"
     id="main_ui_node">
    <div data-dojo-type="dijit/layout/BorderContainer" data-dojo-props="region:'center'">
        <div style="width: 100%;"
             data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'center'">
            <div style="width: 100%; margin-bottom: 5px;">
                <a href="_blank" id="sensor_avg_trend_url_node">{{ history_trend_url_label }}</a>
                <span style="display: inline-block; width: 4px; height: 1px;"></span>
                <a href="_blank" id="sensor_avg_data_url_node">{{ history_data_url_label }}</a>
                <span style="display: inline-block; width: 4px; height: 1px;"></span>
                <select data-dojo-type="dijit/form/Select"
                    id="hours_select_node">
                    {% for idx, hours_tbl in enumerate(hours_tbls) %}
                        {% if 'selected' in hours_tbl %}
                            <option value="{{ hours_tbl["value"] }}" selected="selected">{{ hours_tbl["label"] }}</option>
                        {% else %}
                            <option value="{{ hours_tbl["value"] }}">{{ hours_tbl["label"] }}</option>
                        {% end %}
                    {% end %}
                </select>
                <span style="width: 3px;" />
                <select data-dojo-type="dijit/form/Select"
                        id="mins_interval_select_node">
                    {% for idx, mins_interval in enumerate(mins_interval_tbls) %}
                        {% if 'selected' in mins_interval %}
                            <option value="{{ mins_interval["value"] }}" selected="selected">{{ mins_interval["label"] }}</option>
                        {% else %}
                            <option value="{{ mins_interval["value"] }}">{{ mins_interval["label"] }}</option>
                        {% end %}
                    {% end %}
                </select>
                <button data-dojo-type="dijit/form/Button"
                        id="plot1_btn_node">{{ plot1_label }}
                </button>
                <button data-dojo-type="dijit/form/Button"
                        id="plot2_btn_node">{{ plot2_label }}
                </button>
                <a href="_blank" id="goto_em_url_node">{{ goto_label }}</a>
                <label id="hint_node"></label>
            </div>
            <div id="sensor_grid_node" style="height: 85%;"></div>
        </div>
        <div id="plotting_container_node" style="width: 100%; height: 56%;"
             data-dojo-type="dijit/layout/ContentPane"
             data-dojo-props="region:'bottom', splitter:true, doLayout: true">
        </div>
    </div>
</div>
<div id="standby"></div>
</body>
<script>
    require(["dojo/parser", "dojo/_base/declare", "dojo/_base/lang", "dojo/window", "dojo/on", "dojo/aspect", "dojo/query",
                "dojo/dom", "dojo/dom-construct", "dojo/dom-class", "dojo/dom-geometry", "dojo/_base/array", "dojo/dom-style", "dojo/Deferred",
                "dojo/promise/all", "dojo/cookie", "dojo/json", "dojo/string",
                "dijit/registry", "dijit/Dialog", "dijit/layout/BorderContainer", "dijit/layout/TabContainer", "dijit/layout/ContentPane",
                "dijit/form/Button", "dijit/Tooltip", "dojox/timing", "dojox/collections/Set",
                "dojox/widget/Standby", "dojox/validate", "dgrid/OnDemandGrid", "dgrid/CellSelection", "dgrid/Editor",
                "dgrid/extensions/ColumnHider", "dgrid/Keyboard",
                "dstore/Memory",
                "roundgis/rtutils", "roundgis/dojo_utils",
                "rgw/em_rpc",
                "rgw/SensorTrendBlockUI",
                "rgw/multi_lang",
                "dojo/ready"],
            function (parser, declare, lang, dwin, on, aspect, query, dom, domc, domclass, dgeom, darray, domstyle,
                      Deferred, all, dcookie, djson, dstring, registry,
                      Dialog, BorderContainer, TabContainer, ContentPane, Button, Tooltip,
                      dxtiming, Set, Standby, dx_validate, Grid, Selection, Editor, ColumnHider, Keyboard,
                      Memory,
                      rtutils, dojo_utils,
                      em_rpc,
                      SensorTrendBlockUI,
                      multi_lang, ready) {
                ready(function () {
                    var InitEnv = function () {
                        BasicEnv.standby = new Standby({target: "main_ui_node"});
                        document.body.appendChild(BasicEnv.standby.domNode);
                        BasicEnv.standby.startup();
                        BasicEnv.sensor_col_tbl = {
                            "en": [
                                {
                                    label: " ",
                                    field: "sensor_grid_watched",
                                    autoSave: true,
                                    unhidable: true,
                                    editor: "checkbox"
                                },
                                {field: "sensor_name", label: "Name"},
                                {field: "tag", label: ""},
                                {field: "sensor_val", label: "Status"},
                                {field: "sensor_uts", label: "Time"}
                            ],
                            "zh-cn": [
                                {
                                    label: " ",
                                    field: "sensor_grid_watched",
                                    autoSave: true,
                                    unhidable: true,
                                    editor: "checkbox"
                                },
                                {field: "sensor_name", label: "名字"},
                                {field: "tag", label: ""},
                                {field: "sensor_val", label: "状态"},
                                {field: "sensor_uts", label: "时间"}
                            ],

                            "zh-tw": [
                                {
                                    label: " ",
                                    field: "sensor_grid_watched",
                                    autoSave: true,
                                    unhidable: true,
                                    editor: "checkbox"
                                },
                                {field: "sensor_name", label: "名字"},
                                {field: "tag", label: ""},
                                {field: "sensor_val", label: "狀態"},
                                {field: "sensor_uts", label: "時間"}
                            ]
                        };
                        BasicEnv.sensor_store = new Memory({idProperty: "id"});
                        BasicEnv.hint_node = dom.byId("hint_node");
                        BasicEnv.dialog = new Dialog();
                        BasicEnv.dialog.startup();
                    };

                    var TranslateUI = function() {
                        //dom.byId("sensor_avg_trend_url_node").innerHTML = rtutils.GetLangField(multi_lang.labels["view_trend"], BasicEnv.lang);
                        //dom.byId("sensor_avg_data_url_node").innerHTML = rtutils.GetLangField(multi_lang.labels["view_log"], BasicEnv.lang);
                    };


                    var Sensor2GridItem = function(sensor_tbl) {
                        return {
                            "id": sensor_tbl.id,
                            "sensor_val": sensor_tbl.val,
                            "sensor_name": sensor_tbl.name,
                            "tag": sensor_tbl.tag || "",
                            "data_no": sensor_tbl.data_no,
                            "val_precision": sensor_tbl.val_precision,
                            "val_unit": sensor_tbl.val_unit,
                            "sensor_uts": sensor_tbl.uts,
                            "iconid": sensor_tbl.iconid
                        };
                    };

                    var SetSensorGridCellsHelper = function (switch_items) {
                        (function (mdls) {
                            for (var i = 0; i !== mdls.length; ++i) {
                                var namecell = BasicEnv.sensor_grid.cell(mdls[i].id, "1");
                                if (namecell.element) {
                                    SetNameCell(mdls[i], namecell.element);
                                }
                            }
                        })(switch_items);

                        (function(mdls) {
                            for (var i = 0; i !== mdls.length; ++i) {
                                var namecell = BasicEnv.sensor_grid.cell(mdls[i].id, "2");
                                if (namecell.element) {
                                    SetTagCell(mdls[i], namecell.element);
                                }
                            }
                        })(switch_items);

                        (function (mdls) {
                            for (var i = 0; i !== mdls.length; ++i) {
                                var val_cell = BasicEnv.sensor_grid.cell(mdls[i].id, "3");
                                if (val_cell.element) {
                                    SetSensorValCell(mdls[i], val_cell.element);
                                }
                            }

                        })(switch_items);
                        (function (mdls) {
                            for (var i = 0; i !== mdls.length; ++i) {
                                var uts_cell = BasicEnv.sensor_grid.cell(mdls[i].id, "4");
                                if (uts_cell.element) {
                                    SetUtsCell(mdls[i], uts_cell.element);
                                }
                            }
                        })(switch_items);
                    };

                    var SetSensorGridCells = function () {
                        var items = BasicEnv.sensor_store.fetchSync();
                        SetSensorGridCellsHelper(items);
                    };

                    var SyncSensor = function() {
                        return rtutils.Rpc2Deferred(em_rpc.GetSensor({})).then(
                                    function (result) {
                                        ShowDeviceData(result);
                                    },
                                    function (err) {
                                        rtutils.ReloadWhenExpired(err);
                                        console.log(err);
                                    }
                        );
                    };

                    var ShowDeviceData = function (sensors) {
                        var matched_count = 0;
                        if (sensors.length > 0) {
                            for(var i = 0; i!==sensors.length; ++i) {
                                var sensor_tbl = BasicEnv.sensor_store.getSync(sensors[i].id);
                                if(sensor_tbl) {
                                    matched_count += 1;
                                    rtutils.Mixin(sensor_tbl, Sensor2GridItem(sensors[i]),
                                    ["sensor_name", "sensor_val", "val_precision", "val_unit", "sensor_uts", "tag"]);
                                }
                                else {
                                    BasicEnv.sensor_store.putSync(Sensor2GridItem(sensors[i]));
                                }
                            }
                            if(matched_count !== sensors.length) {
                                BasicEnv.sensor_grid.refresh();
                            }
                            else {
                                SetSensorGridCells();
                            }
                        }
                    };

                    var RenderSensorGridRow = function (row, args) {
                        query(".field-sensor_name", row).forEach(function (node) {
                            SetNameCell(args[0], node);
                        });
                        query(".field-tag", row).forEach(function (node) {
                            SetTagCell(args[0], node);
                        });
                        query(".field-sensor_val", row).forEach(function (node) {
                            SetSensorValCell(args[0], node);
                        });
                        query(".field-sensor_uts", row).forEach(function(node) {
                            SetUtsCell(args[0], node);
                        });
                        return row;
                    };

                    var SetNameCell = function (grid_item, cell_node) {
                        var content = dstring.substitute('<img src="/imgs/${iconid}.png" style="vertical-align:middle"></img>&nbsp;${name}',
                                    {'iconid': grid_item.iconid, 'name': grid_item.sensor_name});
                        if(cell_node.innerHTML !== content) {
                            cell_node.innerHTML = content;
                        }
                    };

                    var SetTagCell = function(grid_item, cell_node) {
                        if(cell_node.innerHTML !== grid_item.tag) {
                            cell_node.innerHTML = grid_item.tag;
                        }
                    };

                    var SetSensorValCell = function(grid_item, cell_node) {
                        var GetValStr = function() {
                            var precision = rtutils.IsValidNumber(grid_item.val_precision)?grid_item.val_precision:1;
                            return grid_item.sensor_val.toFixed(precision);
                        };
                        var content = "N/A";
                        if(rtutils.IsValidNumber(grid_item.sensor_val)) {
                            content = GetValStr()+" "+grid_item.val_unit;
                        }
                        else {
                            content = "N/A";
                        }
                        if(cell_node.innerHTML !== content) {
                            cell_node.innerHTML = content;
                        }
                    };

                    var SetUtsCell = function(grid_item, cell_node) {
                        var content = "N/A";
                        if(rtutils.IsValidNumber(grid_item.sensor_uts) && grid_item.sensor_uts > 0) {
                               content = rtutils.DT2Str4(rtutils.ts2date(grid_item.sensor_uts));
                        }
                        if(cell_node.innerHTML !== content) {
                            cell_node.innerHTML = content;
                        }
                    };

                    var InitSensorGrid = function() {
                        BasicEnv.sensor_grid = new declare([Grid, Selection, Keyboard, Editor, ColumnHider])({
                            columns: rtutils.GetLangField(BasicEnv.sensor_col_tbl, BasicEnv.lang),
                            selectionMode: "single",
                            cellNavigation: true,
                            collection: BasicEnv.sensor_store,
                            minRowsPerPage: 200
                        }, "sensor_grid_node");
                        BasicEnv.sensor_grid.startup();
                        aspect.after(BasicEnv.sensor_grid, "renderRow", function (row, args) {
                            return RenderSensorGridRow(row, args);
                        });
                    };

                    var InitMgrs = function () {
                        BasicEnv.poll_timer = new dxtiming.Timer(30*1000);
                        BasicEnv.poll_timer.onTick = function () {
                            SyncSensor();
                        };
                    };

                    var RefreshApp = function () {
                        BasicEnv.standby.show();
                        var defer_obj = SyncSensor();
                        defer_obj.then(
                                function(flag) {
                                    BasicEnv.standby.hide();
                                    BasicEnv.poll_timer.start();
                                },
                                function(err) {
                                    BasicEnv.standby.hide();
                                    console.log(err);
                                }
                        );
                    };

                    var AfterLogin = function () {
                        InitSensorGrid();
                        InitMgrs();
                        setTimeout(function () {
                            RefreshApp();
                        }, 1500);
                    };

                    var RefreshPlotting1 = function() {
                        var obj = registry.byId("plotting_container_node");
                        var sensorids = BasicEnv.sensor_store.filter({"sensor_grid_watched": true}).select("id").fetchSync();
                        if(sensorids.length > 0) {
                            domc.empty(obj.domNode);
                            rtutils.ShowStandby(BasicEnv.standby);
                            var d_obj = rtutils.Rpc2Deferred(em_rpc.FindSensorMinsAvgLog({
                                'hours': parseInt(registry.byId("hours_select_node").get("value")),
                                'mins_interval': parseInt(registry.byId("mins_interval_select_node").get("value")),
                                'sensorids': sensorids
                            }));
                            d_obj.then(
                                function(result) {
                                    rtutils.HideStandby(BasicEnv.standby);
                                    var chart_height = 86*1.0/sensorids.length;
                                    for(var i = 0; i!=sensorids.length; ++i) {
                                        var trend_block = new SensorTrendBlockUI({
                                            sensor_mdl: result.sensors_tbl[sensorids[i].toString()],
                                            sensor_data_rows: result.log_tbl[sensorids[i].toString()],
                                            ts_series: result.ts_series
                                        });
                                        trend_block.startup();
                                        //domc.place(trend_block.domNode, obj.domNode);
                                        obj.addChild(trend_block);
                                        trend_block.SetHeight(chart_height.toFixed(0)+"%");
                                        trend_block.SetWidth("98%");
                                        domc.create("div", {"style": "display: block; padding: 0.6em 0;"}, obj.domNode);
                                        trend_block.Update();
                                    }
                                },

                                function(err) {
                                    rtutils.HideStandby(BasicEnv.standby);
                                    console.log(err);
                                }
                            );

                        }
                    };

                    var RefreshPlotting2 = function() {
                        var obj = registry.byId("plotting_container_node");
                        var box = dgeom.getContentBox(obj.domNode);
                        var sensorids = BasicEnv.sensor_store.filter({"sensor_grid_watched": true}).select("id").fetchSync();
                        if(sensorids.length > 0) {
                            domc.empty(obj.domNode);
                            rtutils.ShowStandby(BasicEnv.standby);
                            var src_url_base = BasicEnv.curr_location+BasicEnv.sensor_recent_hours_plotting_url;
                            var chart_height = box.h*0.9/sensorids.length;
                            for(var i = 0; i!==sensorids.length; ++i) {
                                var src_url = src_url_base + "?width="+box.w*0.95+"&height="+chart_height+"&tz_offset="+rtutils.GetTimezoneOffset();
                                src_url +="&hours="+registry.byId("hours_select_node").get("value");
                                src_url +="&mins="+registry.byId("mins_interval_select_node").get("value");
                                src_url +="&sensorids="+djson.stringify([sensorids[i]]);
                                var embed_obj = domc.create("embed", {"src": src_url}, obj.domNode);
                            }
                            rtutils.HideStandby(BasicEnv.standby);
                        }
                    };

                    InitEnv();
                    TranslateUI();
                    AfterLogin();

                    on(dom.byId("sensor_avg_trend_url_node"), "click", lang.hitch(this, function(evt) {
                        evt.preventDefault();
                        var sensorids = BasicEnv.sensor_store.filter({"sensor_grid_watched": true}).select("id").fetchSync();
                        if(sensorids.length > 0) {
                            var temp = djson.stringify(sensorids);
                            window.open(BasicEnv.curr_location+BasicEnv.sensor_mins_avg_trend_url+"?sensorids="+temp,BasicEnv.sensor_mins_avg_trend_url);
                        }
                    }));

                    on(dom.byId("sensor_avg_data_url_node"), "click", lang.hitch(this, function(evt) {
                        evt.preventDefault();
                        var sensorids = BasicEnv.sensor_store.filter({"sensor_grid_watched": true}).select("id").fetchSync();
                        if(sensorids.length > 0) {
                            var temp = djson.stringify(sensorids);
                            window.open(BasicEnv.curr_location+BasicEnv.sensor_mins_avg_data_url+"?ids="+temp,BasicEnv.sensor_mins_avg_data_url);
                        }
                    }));

                    on(registry.byId("plot1_btn_node"), "click", lang.hitch(this, function(evt) {
                        RefreshPlotting1();
                    }));

                    on(registry.byId("plot2_btn_node"), "click", lang.hitch(this, function(evt) {
                        RefreshPlotting2();
                    }));

                    on(dom.byId("goto_em_url_node"), "click", function(evt) {
                        evt.preventDefault();
                        window.open(BasicEnv.curr_location+BasicEnv.em_url,
                                    BasicEnv.em_url);

                    });
                });
            });
</script>
</html>